package main

import "C"
import (
	"encoding/json"
	"unsafe"
)

/* CUSTOM IMPORTS */

/* CODE */

//export PluginWrapper
func PluginWrapper(dst *byte, dstLen int, requestCtxJson *byte, requestCtxJsonLen int) uintptr {
	// 解析输入
	requestCtxJson := unsafe.Slice(requestCtxJson, requestCtxJsonLen)
	requestCtx := new(fuzzTypes.RequestCtx)
	if err := json.Unmarshal(requestCtxJson, RequestCtx); err != nil {
		return ^uintptr(0)
	}

	// 调用核心逻辑
	resp := /* FUN_NAME */(RequestCtx)

	// 序列化
	respJson, err := json.Marshal(resp)
	if err != nil {
	    return ^uintptr(0)
	}

	// 计算需要的大小 (4字节长度 + 数据)
	needed := len(respJson)

	// 如果调用方给的缓冲区不足，直接返回需要的大小
	if dst == nil || dstLen < needed {
		return uintptr(needed)
	}

	// 写入到调用方提供的缓冲区
	buf := unsafe.Slice(dst, dstLen)
	copy(buf, respJson)

	// 返回实际写入的大小
	return uintptr(needed)
}

func main() {}
